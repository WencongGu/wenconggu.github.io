---
title: 数据库并发控制概述
date: 2023-12-15 17:14:44
tags: 
    - SQL
mathjax: true
---

数据库是可共享的资源，可供多个用户使用。为了提高使用效率，有必要考虑设计运行数据库进行并行处理。但是这会带来一些问题。

<!--more-->

## 并发带来的一些问题

### 丢失修改

两个事务同时读取某一个数据，其中一个事务对数据进行修改并提交，随后另一个事务也修改并提交，此时会覆盖第一个事务的数据修改。

### 脏读

一个事务读取了另一个事务未提交的修改，此时事务可能回滚重置数据修改。

### 不可重复读

一个事务先后读取了同一条记录，但可能由于存在其他事务的修改，两次读取的数据不同。

### 幻读

一个事务读取了一条记录，但是其他事务可能执行删除或者插入操作，导致读取产生偏差。

## 主要技术

并发控制的主要技术有封锁、时间戳、乐观方法、多版本并发控制等。

## 事务级别的隔离

|隔离级别|丢失修改|脏读|不可重复读|幻读|
|:-:|  :-: |:-:|  :-:|  :-:|
|读未提交|可能|可能|可能|可能|
|读已提交|不可能|可能|可能|可能|
|可重复读|不可能|不可能|可能|可能|
|可串行化|不可能|不可能|不可能|不可能|

## 封锁

封锁是并发控制的主要手段，通过封锁数据可以解决并发控制带来的问题。

封锁分为两种：

- 排他锁（X）：不允许其他事务读取或者修改封锁的数据。
- 共享锁（S）：允许事务读取数据，但不允许其他事务修改数据。

对一个对象加上排他锁之后不能再加其他任何锁；加了共享锁之后只能再加共享锁。

### 封锁协议

1. 一级封锁协议：事务开始时对它需要的所有数据加上X锁，事务结束时释放所有锁。
2. 二级封锁协议：一级封锁协议基础上，事务开始时对它需要的所有数据加上S锁，读取结束时释放所有锁。
3. 三级封锁协议：一级封锁协议基础上，事务开始时对它需要的所有数据加上S锁，事务结束时释放所有锁。

|协议|不丢失修改|不脏读|可重复读|隔离级别保证|
|:-:|:-:|:-:|:-:|:-:|
|一级封锁协议|Y|N|N|读未提交|
|二级封锁协议|Y|Y|N|读已提交|
|三级封锁协议|Y|Y|Y|可重复读|

### 死锁

死锁是指两个或多个事务在执行过程中，因争夺资源而造成的一种互相等待的现象。

与死锁对应的还有活锁，比如事务2等待1，此时3也请求1，事务1在完成操作后会首先允许事务3，此时事务4可能也开始等待，于是先允许事务4......这样事务2可能会一直等待下去。活锁是很好解决的，使用先来先服务即可。

产生死锁的必要条件：

- 互斥条件：一个资源每次只能被一个进程使用。
- 请求和保持条件：一个进程因请求资源而阻塞时，对已获得的资源保持不放。
- 不剥夺条件：进程已获得的资源，在末使用之前，不能强行剥夺。
- 循环等待条件：若干进程之间形成一种头尾相接的循环等待资源关系。

死锁的预防有两种方式：

1. 一次封锁法
   事务一次封锁所有的资源。显然会造成资源浪费，降低并发度
2. 顺序封锁法
   事务按顺序封锁资源。但是待封锁对象过多，实现难度大

因此一般采取对死锁进行诊断与解除的方法。

### 死锁的检测和解除

1. 超时法
   容易造成误判，同时不能及时发现
2. 事务等待图
   使用一个有向图，事务作为节点，等待为边，发起等待的事务是边的起点，等待对象是终点。这方面已经有深入研究。

### 两段锁协议

事务必须分为两个阶段对资源进行加锁和释放。加锁阶段即使扩展阶段，释放阶段是收缩阶段。遵循两段锁协议的调度是可串行化的。

### 意向锁

意向共享型锁（IS锁）、意向排他型锁（IX锁）、共享意向排他型锁（SIX锁）

- IS：给一个数据IS锁表示他的后裔节点拟加S锁
- IX：对一个数据对象加IX锁表示后裔节点拟加X锁
- SIX：对一个数据对象加SIX锁表示对他加S锁，再加IX锁

具有意向锁的多粒度封锁办法提高了系统的并发图，减少了加锁和解锁的开销。

## 其他方法

- 时间戳方法给每个事物改成一个时标及事物开始执行的时间，每个事物具有唯一的时间戳，并按照这个时间出来解决事物的冲突操作如果发生冲突操作就回滚具有较长时间出的事物，以保证其他事物的正常运行，被回滚的事物被赋予新的时间戳，并从头开始执行
- 乐观方法认为事物执行时很少发生冲突，因此不对事物进行特殊的管制，而是让他自由执行事物提交前再进行正确性检查。如果检查后发现事务执行过程中出现过冲突并影响了可串行性，则拒绝提交并会滚事务。乐观方法又被称为验证方法。
- 多版本并发控制（MVCC）方法是指在数据库中通过维护数据对象的多个版本信息来实现高效并发控制的一种策略。

>COUNT
>参考书籍：《数据库系统概论》，王珊，杜小勇，陈红，编著，高等教育出版社，2023年3月第6版